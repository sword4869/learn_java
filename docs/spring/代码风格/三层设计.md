- 控制层：controller
- 业务层：service
- 持久层/数据访问层：dao

## controller

前后端工程在进行交互时，使用**统一响应结果** Result。

~~~java
package com.itheima.pojo;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Result {
    private Integer code;//响应码，1 代表成功; 0 代表失败
    private String msg;  //响应信息 描述字符串
    private Object data; //返回的数据

    //增删改 成功响应
    public static Result success(){
        return new Result(1,"success",null);
    }
    //查询 成功响应
    public static Result success(Object data){
        return new Result(1,"success",data);
    }
    //失败响应
    public static Result error(String msg){
        return new Result(0,msg,null);
    }
}
~~~

## service

### 统一响应结果 or noth

如果返回统一响应结果，那么虽然报错信息能给前端一层一层往上传，但是写的东西很多（统一响应结果的包装）。

![image-20240726143407143](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202407261434323.png)

![image-20240726143907790](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202407261439848.png)

不如直接抛出异常，靠全局异常处理器来处理，具体的错误信息就用log记录得了。

- service: 只有查才返回，其他都是void不返回
- mapper: 只有查才返回具体类型，其他**增删改**都是int来判断成功与否。
- controller: 只返回ok的统一类型，失败的统一返回类型则由全局异常处理器来做。

![image-20240726150926424](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202407261509494.png)

![image-20240726151104003](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202407261511092.png)



![image-20240726153022951](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202407261530022.png)

![image-20240726150947133](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202407261509194.png)

### page

```java
/**
 * 获取教师信息（分页）
 * @param teacherInfoCriteria
 * @return
 */
@GetMapping(WebURIMappingConstant.REQUEST_MAPPING_INSTITUTION_BASIC_TEACHER)
public Rest<JsonPagedVO<TeacherInfoVO>> getTeacher(@Validated TeacherInfoCriteria teacherInfoCriteria) {	// 分页参数和机构id
    LOGGER.info("获取教师信息 {}", teacherInfoCriteria);
    JsonPagedVO<TeacherInfoVO> teacherList = teacherService.getTeacherList(teacherInfoCriteria);
    return RestBody.okData(teacherList);
}
```

```java
@Data
public class TeacherInfoCriteria extends AbstractPaginationQueryCondition {
    @NotNull
    private Long institutionId;

    @Override
    public Integer getStart() {
        final Integer page = getPage();
        final Integer limit = getLimit();
        if (page != null && limit != null) {
            return (page - 1) * limit;
        }
        return null;
    }

    @Override
    public String toString() {
        return "TeacherInfoCriteria{" +
                "institutionId=" + institutionId +
                ", page=" + getPage() +
                ", limit=" + getLimit() +
                ", start=" + getStart() +
                '}';
    }
}

public abstract class AbstractPaginationQueryCondition {
    private Integer start = 0;		// start = limit * (page - 1)
    private Integer limit = 20;		// 每页数据有几条
    private Integer page = 1;		// 第几页
}
```



```java
@Override
public JsonPagedVO<TeacherInfoVO> getTeacherList(TeacherInfoCriteria teacherInfoCriteria) {
    Objects.requireNonNull(teacherInfoCriteria, "teacherInfoCriteria is null");
    // 先查询总数
    final Long total = teacherInfoMapper.queryTeacherInfoTotal(teacherInfoCriteria);
    // 查询当前页数据
    final List<TeacherInfoVO> teacherInfoVOList = total > 0 ? teacherInfoMapper.queryTeacherInfoPage(teacherInfoCriteria) : List.of();
    LOGGER.info("获取教师信息列表，总数：{}，当前页数据：{}", total, teacherInfoVOList);
    return new JsonPagedVO<>(teacherInfoVOList, total);
}
```

```xml
<!--查询信息总数-->
<select id="queryTeacherInfoTotal" resultType="java.lang.Long">
    SELECT COUNT(*)
    from t_teacher_info ti
             join t_label_teacher lt on ti.id = lt.teacher_id
             join sys_parameter sp on lt.label_code = sp.code and sp.type = 'custom_tab'
             join sys_parameter sp2 on ti.gender = sp2.code and sp2.type = 'gender'
    where ti.institution_id = #{institutionId} and ti.deleted_flag = false
</select>

<!--查询信息分页-->
<select id="queryTeacherInfoPage" resultMap="VOmap">
    select
        ti.id, ti.institution_id, ti.teacher_name, ti.id_num, sp2.name gender, ti.phone, sp.name label_code
    from t_teacher_info ti
             join t_label_teacher lt on ti.id = lt.teacher_id
             join sys_parameter sp on lt.label_code = sp.code and sp.type = 'custom_tab'
             join sys_parameter sp2 on ti.gender = sp2.code and sp2.type = 'gender'
    where ti.institution_id = #{institutionId} and ti.deleted_flag = false
    order by ti.id desc
    limit #{limit} offset #{start}
</select>
```





## mapper

PO数据库实体类；

VO返回给前端；

DTO和Criteria（选项查询条件）是接受前端参数的，DTO还可以用于后端服务之间传递参数。



insert: Controller里接收VO，Service接收VO、处理为PO，交给Mapper写sql。

​	如果VO只有主键id和PO不一样，可以不用写VO，使用PO 并且 insert sql 里 不注入 id 就行。

select: Mapper里查的列直接对应到VO类上。