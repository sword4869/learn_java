- [char varch](#char-varch)
- [whereä¸ŽhavingåŒºåˆ«](#whereä¸ŽhavingåŒºåˆ«)
- [æœ‰å“ªäº›çº¦æŸ](#æœ‰å“ªäº›çº¦æŸ)
- [äº‹åŠ¡ä¼šä¸ä¼šè‡ªåŠ¨æäº¤?](#äº‹åŠ¡ä¼šä¸ä¼šè‡ªåŠ¨æäº¤)
- [äº‹åŠ¡çš„ACID](#äº‹åŠ¡çš„acid)
- [åŽŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ä»–ä»¬åˆ†åˆ«æ˜¯æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ](#åŽŸå­æ€§ä¸€è‡´æ€§éš”ç¦»æ€§å’ŒæŒä¹…æ€§ä»–ä»¬åˆ†åˆ«æ˜¯æœ‰ä»€ä¹ˆä½œç”¨)
- [ACIDçš„å®žçŽ°](#acidçš„å®žçŽ°)
- [äº‹åŠ¡å¹¶å‘çš„ä¸‰ç§å¹¶å‘é—®é¢˜ï¼Ÿè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»](#äº‹åŠ¡å¹¶å‘çš„ä¸‰ç§å¹¶å‘é—®é¢˜è„è¯»ä¸å¯é‡å¤è¯»å¹»è¯»)
- [äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ï¼Œä½œç”¨åˆ†åˆ«æ˜¯ï¼Ÿ](#äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ä½œç”¨åˆ†åˆ«æ˜¯)
- [å¹»è¯»é—®é¢˜æ€Žä¹ˆè§£å†³ã€‚](#å¹»è¯»é—®é¢˜æ€Žä¹ˆè§£å†³)
- [MySQLçš„ä½“ç³»ç»“æž„](#mysqlçš„ä½“ç³»ç»“æž„)
- [innodbçš„é€»è¾‘å­˜å‚¨ç»“æž„](#innodbçš„é€»è¾‘å­˜å‚¨ç»“æž„)
- [Buffer Pool](#buffer-pool)
- [mysqlçš„ä¸‰ç§å­˜å‚¨å¼•æ“Ž](#mysqlçš„ä¸‰ç§å­˜å‚¨å¼•æ“Ž)
- [mysql b+æ ‘å’Œbæ ‘](#mysql-bæ ‘å’Œbæ ‘)
- [ä¸ºä»€ä¹ˆInnoDBå­˜å‚¨å¼•æ“Žé€‰æ‹©ä½¿ç”¨B+treeç´¢å¼•ç»“æž„?](#ä¸ºä»€ä¹ˆinnodbå­˜å‚¨å¼•æ“Žé€‰æ‹©ä½¿ç”¨btreeç´¢å¼•ç»“æž„)
- [InnoDBä¸»é”®ç´¢å¼•çš„B+treeé«˜åº¦ä¸ºå¤šé«˜å‘¢?](#innodbä¸»é”®ç´¢å¼•çš„btreeé«˜åº¦ä¸ºå¤šé«˜å‘¢)
- [äº†è§£è¿‡ç´¢å¼•å—ï¼Ÿï¼ˆä»€ä¹ˆæ˜¯ç´¢å¼•ï¼‰](#äº†è§£è¿‡ç´¢å¼•å—ä»€ä¹ˆæ˜¯ç´¢å¼•)
- [ç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æž„äº†è§£è¿‡å˜› ?](#ç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æž„äº†è§£è¿‡å˜›-)
- [mysqlçš„ç´¢å¼•æœ‰å“ªäº›](#mysqlçš„ç´¢å¼•æœ‰å“ªäº›)
- [èšé›†ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•](#èšé›†ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•)
- [å›žè¡¨æŸ¥è¯¢](#å›žè¡¨æŸ¥è¯¢)
- [ðŸš€èšé›†ç´¢å¼•é€‰å–è§„åˆ™](#èšé›†ç´¢å¼•é€‰å–è§„åˆ™)
- [è”åˆç´¢å¼•åº•å±‚å­˜å‚¨ç»“æž„(å’Œå…¶ä»–ç§ç±»çš„ç´¢å¼•çš„å­˜å‚¨ç»“æž„æœ‰ä»€ä¹ˆåŒºåˆ«?)](#è”åˆç´¢å¼•åº•å±‚å­˜å‚¨ç»“æž„å’Œå…¶ä»–ç§ç±»çš„ç´¢å¼•çš„å­˜å‚¨ç»“æž„æœ‰ä»€ä¹ˆåŒºåˆ«)
- [è”åˆç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜çš„ä»€ä¹ˆå†…å®¹?](#è”åˆç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜çš„ä»€ä¹ˆå†…å®¹)
- [è¦†ç›–ç´¢å¼•](#è¦†ç›–ç´¢å¼•)
- [MYSQLè¶…å¤§åˆ†é¡µæ€Žä¹ˆå¤„ç† ?](#mysqlè¶…å¤§åˆ†é¡µæ€Žä¹ˆå¤„ç†-)
- [ç´¢å¼•å¤±æ•ˆ](#ç´¢å¼•å¤±æ•ˆ)
- [ç´¢å¼•è®¾è®¡åŽŸåˆ™](#ç´¢å¼•è®¾è®¡åŽŸåˆ™)
- [MySQLä¸­çš„é”](#mysqlä¸­çš„é”)
- [æ•°æ®åº“ä¸»ä»ŽåŒæ­¥](#æ•°æ®åº“ä¸»ä»ŽåŒæ­¥)
- [MySQLä¸­ï¼Œå¦‚ä½•å®šä½æ…¢æŸ¥è¯¢?](#mysqlä¸­å¦‚ä½•å®šä½æ…¢æŸ¥è¯¢)
- [é‚£è¿™ä¸ªSQLè¯­å¥æ‰§è¡Œå¾ˆæ…¢, å¦‚ä½•åˆ†æžå‘¢ï¼Ÿ](#é‚£è¿™ä¸ªsqlè¯­å¥æ‰§è¡Œå¾ˆæ…¢-å¦‚ä½•åˆ†æžå‘¢)
- [bin logã€undo logã€redo logçš„åŒºåˆ«](#bin-logundo-logredo-logçš„åŒºåˆ«)
- [äº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Ÿ(ä½ è§£é‡Šä¸€ä¸‹MVCC)](#äº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ä½ è§£é‡Šä¸€ä¸‹mvcc)
- [MySQLä¸»ä»ŽåŒæ­¥åŽŸç†](#mysqlä¸»ä»ŽåŒæ­¥åŽŸç†)
- [åˆ†åº“åˆ†è¡¨](#åˆ†åº“åˆ†è¡¨)
- [é‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—ï¼Ÿ](#é‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—)


---

## char varch

char ä¸Ž varchar éƒ½å¯ä»¥æè¿°å­—ç¬¦ä¸²ã€‚

charæ˜¯å®šé•¿å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šé•¿åº¦å¤šé•¿ï¼Œå°±å ç”¨å¤šå°‘ä¸ªå­—ç¬¦ï¼Œå’Œå­—æ®µå€¼çš„é•¿åº¦æ— å…³ ã€‚è€Œvarcharæ˜¯å˜é•¿å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šçš„é•¿åº¦ä¸ºæœ€å¤§å ç”¨é•¿åº¦ï¼Œå®žé™…å ç”¨é•¿åº¦ä¸ºä¼ å…¥å­—æ®µå€¼é•¿åº¦ã€‚

charçš„æ€§èƒ½ä¼šæ›´é«˜äº›ï¼Œvarcharæ›´çœç©ºé—´ã€‚


## whereä¸ŽhavingåŒºåˆ«
- æ‰§è¡Œæ—¶æœºä¸åŒï¼šwhereæ˜¯åˆ†ç»„ä¹‹å‰è¿›è¡Œè¿‡æ»¤ï¼Œä¸æ»¡è¶³whereæ¡ä»¶ï¼Œä¸å‚ä¸Žåˆ†ç»„ï¼›è€Œhavingæ˜¯åˆ†ç»„
ä¹‹åŽå¯¹ç»“æžœè¿›è¡Œè¿‡æ»¤ã€‚
- åˆ¤æ–­æ¡ä»¶ä¸åŒï¼šwhereä¸èƒ½å¯¹èšåˆå‡½æ•°è¿›è¡Œåˆ¤æ–­ï¼Œè€Œhavingå¯ä»¥ã€‚

## æœ‰å“ªäº›çº¦æŸ

6ä¸ª

ä¸»é”®ã€å¤–é”®ï¼›éžç©ºã€å”¯ä¸€ã€ï¼›é»˜è®¤å€¼ã€æ£€æŸ¥


## äº‹åŠ¡ä¼šä¸ä¼šè‡ªåŠ¨æäº¤?

MySQL é»˜è®¤å¼€å¯äº‹åŠ¡è‡ªåŠ¨æäº¤æ¨¡å¼ï¼Œæ¯ä¸ªå•ç‹¬çš„DMLè¯­å¥éƒ½å°†è‡ªåŠ¨æˆä¸ºä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶åœ¨æ‰§è¡Œå®ŒæˆåŽç«‹å³æäº¤ã€‚

- å¦‚ä½•é˜»æ­¢è‡ªåŠ¨æäº¤ï¼Ÿæ˜¾å¼çš„å¼€å¯äº‹åŠ¡ï¼ˆBEGIN æˆ– START TRANSACTIONï¼‰ã€‚

- å¦‚ä½•å¼€å¯è‡ªåŠ¨æäº¤ï¼š

    ```
    SET @@autocommit = 1;
    // DMLè¯­å¥
    ```

    æˆ–è€…å¯ä»¥åœ¨è¿žæŽ¥åˆ°æ•°æ®åº“æ—¶åœ¨è¿žæŽ¥å­—ç¬¦ä¸²ä¸­æŒ‡å®š`autocommit`å‚æ•°ä¸º1ã€‚

    ```
    mysql -u username -p -h hostname dbname --autocommit=1
    ```

- å¦‚æžœæƒ³è¦ç¦ç”¨è‡ªåŠ¨æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è¯­å¥ï¼š

    ```
    SET @@autocommit = 0;
    ```

    æˆ–è€…åœ¨è¿žæŽ¥å­—ç¬¦ä¸²ä¸­æŒ‡å®š`autocommit`å‚æ•°ä¸º0ã€‚

## äº‹åŠ¡çš„ACID

- åŽŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›žæ»šã€‚
- ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œ(æˆåŠŸæäº¤æˆ–å¤±è´¥å›žæ»š)å‰åŽï¼Œæ•°æ®åº“éƒ½åº”è¯¥ä¿æŒä¸€è‡´æ€§çŠ¶æ€ã€‚
- éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªå¹¶å‘çš„äº‹åŠ¡ä¹‹é—´åº”è¯¥äº’ç›¸éš”ç¦»ï¼Œé¿å…äº’ç›¸å¹²æ‰°ã€‚
- æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡æäº¤åŽï¼Œå¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸åº”è¯¥ä¸¢å¤±ã€‚

PSï¼šä¸€è‡´æ€§ï¼šæ•°æ®åº“å†…éƒ¨çš„**å®Œæ•´æ€§**çº¦æŸã€å£°æ˜Žæ€§çº¦æŸã€‚è½¬è´¦ï¼Œä¸¤ç”¨æˆ·æ€»é‡‘é¢ä¸å˜ã€‚

## åŽŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ä»–ä»¬åˆ†åˆ«æ˜¯æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

- åŽŸå­æ€§ï¼šä¿è¯ï¼ˆäº‹åŠ¡ä¸­æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›žæ»šï¼‰ï¼Œé¿å…å› ä¸ºéƒ¨åˆ†æ“ä½œå¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–é”™è¯¯çš„ç»“æžœã€‚
- ä¸€è‡´æ€§ï¼šä¿è¯ï¼ˆäº‹åŠ¡æ‰§è¡Œå‰åŽï¼Œæ•°æ®åº“éƒ½åº”è¯¥ä¿æŒä¸€è‡´æ€§çŠ¶æ€ï¼‰ï¼Œé¿å…æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚
- éš”ç¦»æ€§ï¼šä¿è¯ï¼ˆå¤šä¸ªå¹¶å‘çš„äº‹åŠ¡ä¹‹é—´åº”è¯¥äº’ç›¸éš”ç¦»ï¼Œé¿å…äº’ç›¸å¹²æ‰°ï¼‰ï¼Œé¿å…è¯»å–åˆ°æœªæäº¤çš„æ•°æ®æˆ–è€…è„æ•°æ®ï¼Œé¿å…å¹¶å‘æ“ä½œå¯¼è‡´çš„æ•°æ®å†²çªã€‚
- æŒä¹…æ€§ï¼šä¿è¯ï¼ˆäº‹åŠ¡æäº¤åŽï¼Œå¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸åº”è¯¥ä¸¢å¤±ï¼‰ï¼Œé¿å…æ•°æ®çš„ä¸¢å¤±å’Œä¸å¯æ¢å¤ã€‚

## ACIDçš„å®žçŽ°

åŽŸå­æ€§å’Œä¸€è‡´æ€§ï¼šundo log

æŒä¹…æ€§ï¼šredo log

éš”ç¦»æ€§ï¼šé”å’Œmvcc

## äº‹åŠ¡å¹¶å‘çš„ä¸‰ç§å¹¶å‘é—®é¢˜ï¼Ÿè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»

ç”±äºŽå¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œè€Œç¼ºä¹ä¸€å®šçš„éš”ç¦»æ€§å’ŒåŒæ­¥æœºåˆ¶ã€‚

è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»æ˜¯æ•°æ®åº“ä¸­çš„ä¸‰ç§å¹¶å‘é—®é¢˜ï¼š

> è„è¯»ï¼ˆDirty Readï¼‰

è„è¯»ï¼šè¯»æœªæäº¤ã€‚

ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œå¦‚æžœå¦ä¸€ä¸ªäº‹åŠ¡å›žæ»šï¼Œåˆ™è¯»å–çš„æ•°æ®æ˜¯æ— æ•ˆçš„

> ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰ï¼š

ä¸€ä¸ªäº‹åŠ¡å¯¹åŒä¸€æ•°æ®è¿›è¡Œä¸¤æ¬¡æŸ¥è¯¢ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åœ¨ä¸¤æ¬¡æŸ¥è¯¢æœŸé—´ä¿®æ”¹äº†æ•°æ®ï¼Œå¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´ã€‚

> å¹»è¯»ï¼ˆPhantom Readï¼‰

å¹»è¯»ä¸Žä¸å¯é‡å¤è¯»ç±»ä¼¼ï¼Œå½±å“åˆ°äº‹åŠ¡Açš„**å¢žåˆ **é€»è¾‘ã€‚å¦‚åŒå¢žåˆ çš„ç©ºæ°”å¢™ã€‚

äº‹åŠ¡AæŸ¥è¯¢åŽå‡†å¤‡æ’å…¥ï¼Œäº‹åŠ¡Båœ¨ä¸¤æ¬¡æŸ¥è¯¢æœŸé—´æ’å…¥äº†æ•°æ®ï¼Œäº‹åŠ¡Aè¿™æ—¶æ’å…¥ä¸€æ¡å’Œäº‹åŠ¡Bä¸€æ ·çš„å†…å®¹æ—¶ï¼Œä¼šæŠ¥é”™é‡å¤æ•°æ®ã€‚ä½†æ˜¯äº‹åŠ¡Aä¸­çœ‹ä¸åˆ°æ™šäºŽäº‹åŠ¡Aä»¥åŽå…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®ï¼Œå¤šå‡ºçš„æ•°æ®å®žé™…ä¹Ÿæ˜¯çœ‹ä¸åˆ°çš„ã€‚

PS: å¹¶å‘é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨ä¸åŒçš„**éš”ç¦»çº§åˆ«å’Œé”æœºåˆ¶**æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚

## äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å“ªå‡ ç§ï¼Œä½œç”¨åˆ†åˆ«æ˜¯ï¼Ÿ


æ•°æ®åº“äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å››ç§ï¼Œåˆ†åˆ«ä¸ºè¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰ã€è¯»å·²æäº¤ï¼ˆRead Committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚

-   è¯»æœªæäº¤ï¼šæœ€ä½Žçš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸ä¸€ä¸ªäº‹åŠ¡è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡**æœªæäº¤**çš„æ•°æ®ã€‚è¿™ç§éš”ç¦»çº§åˆ«ä¼šå¯¼è‡´è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜ã€‚
-   è¯»å·²æäº¤ï¼šå…è®¸ä¸€ä¸ªäº‹åŠ¡è¯»å–å¦ä¸€ä¸ªäº‹åŠ¡**å·²æäº¤**çš„æ•°æ®ï¼Œé¿å…äº†è„è¯»é—®é¢˜ã€‚ä½†æ˜¯ä»ç„¶å¯èƒ½å­˜åœ¨ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜ã€‚
-   å¯é‡å¤è¯»ï¼š**ä¿è¯ä¸€ä¸ªäº‹åŠ¡å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®æ—¶ï¼Œèƒ½å¤Ÿå¾—åˆ°ç›¸åŒçš„ç»“æžœ**ï¼Œé¿å…äº†ä¸å¯é‡å¤è¯»é—®é¢˜ã€‚ä½†æ˜¯ä»ç„¶å¯èƒ½å­˜åœ¨å¹»è¯»é—®é¢˜ã€‚
-   ä¸²è¡ŒåŒ–ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œ**å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œ**ï¼Œé¿å…äº†æ‰€æœ‰å¹¶å‘é—®é¢˜ï¼Œä½†æ˜¯ä¼šå¯¼è‡´**æ€§èƒ½ä¸‹é™**ã€‚


é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«å–å†³äºŽåº”ç”¨åœºæ™¯å’Œæ€§èƒ½è¦æ±‚ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ**å¯é‡å¤è¯», èƒ½å¤Ÿåœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶å…¼é¡¾æ€§èƒ½**ï¼Œè¿™ä¹Ÿæ˜¯mysqlé»˜è®¤çš„éš”ç¦»çº§åˆ«ã€‚

## å¹»è¯»é—®é¢˜æ€Žä¹ˆè§£å†³ã€‚

1. MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºä¸²è¡ŒåŒ–çš„éš”ç¦»çº§åˆ«ã€‚

2. InnoDB å½“å‰è¯»ä¸‹çš„å¹»è¯»æ˜¯é€šè¿‡é—´éš™é”ï¼ˆgap_lock)æ¥å®žçŽ°çš„ã€‚åœ¨äº‹åŠ¡AæŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šé”ä½ä¸€ä¸ªé—´éš™ï¼Œå…¶å®ƒäº‹åŠ¡å¾€è¿™ä¸ªé—´éš™æ’å…¥ã€åˆ é™¤ç­‰æ“ä½œéƒ½æ˜¯ä¼šè¢«é”é˜»å¡žçš„ã€‚é—´éš™é”å’Œæ’å…¥æ„å‘é”äº’æ–¥ï¼Œå½»åº•è§£å†³äº†å½“å‰è¯»ä¸‹çš„å¹»è¯»é—®é¢˜ã€‚

3. ä½†æ˜¯InnoDB æ²¡æœ‰å®Œå…¨è§£å†³å¿«ç…§è¯»ä¸‹çš„å¹»è¯»é—®é¢˜ã€‚

## MySQLçš„ä½“ç³»ç»“æž„

è¿žæŽ¥å±‚ã€æœåŠ¡å±‚ã€å¼•æ“Žå±‚ã€å­˜å‚¨å±‚ã€‚

## innodbçš„é€»è¾‘å­˜å‚¨ç»“æž„

**è¡¨ç©ºé—´-æ®µ-åŒº-é¡µ-è¡Œ**ï¼ˆæ ‡æ®µåŽ»å¤œèˆªï¼‰

é¡µä¹Ÿæ˜¯InnoDB å­˜å‚¨å¼•æ“Žç£ç›˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œ**16KB**ã€‚

## Buffer Pool

https://zhuanlan.zhihu.com/p/488819733

MySQL çš„æ•°æ®æ˜¯å­˜å‚¨åœ¨ç£ç›˜é‡Œçš„ï¼Œæ¯æ¬¡åŽ»ç¡¬ç›˜è¯»æ•°æ®å¤ªæ…¢ã€‚å¼•å…¥ç¼“å­˜ï¼Œç¼“å†²æ± ï¼ˆBuffer Poolï¼‰æ¥æé«˜æ•°æ®åº“çš„è¯»å†™æ€§èƒ½ã€‚åœ¨æ‰§è¡Œå¢žåˆ æ”¹æŸ¥æ“ä½œæ—¶ï¼Œå…ˆæ“ä½œä¸»å†…å­˜ä¸­ç¼“å†²æ± ä¸­çš„æ•°æ®ï¼ˆè‹¥ç¼“å†²æ± æ²¡æœ‰æ•°æ®ï¼Œåˆ™ä»Žç£ç›˜åŠ è½½å¹¶ç¼“å­˜ï¼‰ï¼Œç„¶åŽä»¥ä¸€å®šé¢‘çŽ‡åˆ·æ–°åˆ°ç£ç›˜ï¼Œä»Žè€Œå‡å°‘ç£ç›˜IOï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦ã€‚

â†’ è¯»ã€‚ç¼“å­˜æ± ä¸­å­˜ç¼“å­˜é¡µï¼Œå°†ç£ç›˜ä¸­çš„é¡µæ¢è¿›æ¥ã€‚

â†’ æ¯”èµ·åœ¨æ•´ä¸ªç¼“å†²æ± ä¸­æ‰¾ç©ºé—²é¡µï¼Œç”¨free é“¾è¡¨å­˜ç©ºé—²é¡µã€‚

â†’ é“¾è¡¨æ˜¯å•å“¨å…µåŒå‘å¾ªçŽ¯é“¾è¡¨ã€‚æ•°æ®ç»“ç‚¹æ˜¯æŽ§åˆ¶å—ï¼Œä¸€ä¸ªæŽ§åˆ¶å—å¯¹åº”ä¸€ä¸ªç¼“å­˜é¡µï¼Œåœ¨å†…å­˜ä¸­æŽ§åˆ¶å—1-Né›†ä¸­å­˜å‚¨ï¼ŒåŽé¢é›†ä¸­å­˜1-Nçš„ç¼“å­˜é¡µï¼Œä¸­é—´å¯èƒ½ä¼šæœ‰ç¢Žç‰‡ç©ºé—´ã€‚

â†’ å æ®æ»¡äº†å°±è¦è¢«æ·˜æ±°æ‰èƒ½æ¢æ–°çš„ç¼“å­˜é¡µï¼Œé‚£ä¹ˆå¼•å…¥LRUæœºåˆ¶ã€‚LRUé“¾è¡¨ç®¡ç†è¢«ä½¿ç”¨è¿‡çš„é¡µã€‚

â†’ è¢«ä½¿ç”¨è¿‡çš„é¡µï¼ŒåŒ…æ‹¬æ²¡è¢«ä¿®æ”¹çš„cleané¡µå’Œè¢«ä¿®æ”¹è¿‡çš„è„é¡µã€‚

â†’ è„é¡µç”± flush é“¾è¡¨ç®¡ç†ï¼Œæ¯”èµ·ä¿®æ”¹ä¸€æ¬¡å°±å†™ä¸€æ¬¡çš„é¢‘ç¹IOï¼Œé›†ä¸­å†™å…¥ flush é“¾è¡¨çš„å†™å…¥æ€§èƒ½æ›´é«˜ã€‚

â†’ å¯¹LRUæœºåˆ¶è¿˜åšäº†2.5ç‚¹ä¼˜åŒ–ï¼šé¢„è¯»å¤±æ•ˆã€ç¼“å­˜æ±¡æŸ“ã€‚

- è„é¡µä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ·å…¥ç£ç›˜ï¼Ÿ
- å‡ ä¸ªé“¾è¡¨ï¼Œå‡ ä¸ªé¡µ
- é¢„è¯»å¤±æ•ˆçš„youngã€oldè¿‡ç¨‹
- ç¼“å­˜æ±¡æŸ“


## mysqlçš„ä¸‰ç§å­˜å‚¨å¼•æ“Ž

innodb(é»˜è®¤), myisam, memory


- InnoDBå¼•æ“Ž, æ”¯æŒäº‹åŠ¡, è€ŒMyISAMä¸æ”¯æŒã€‚
- InnoDBå¼•æ“Ž, æ”¯æŒè¡Œé”å’Œè¡¨é”, è€ŒMyISAMä»…æ”¯æŒè¡¨é”, ä¸æ”¯æŒè¡Œé”ã€‚
- InnoDBå¼•æ“Ž, æ”¯æŒå¤–é”®, è€ŒMyISAMæ˜¯ä¸æ”¯æŒçš„
- memoryå­˜å‚¨è¡¨åœ¨å†…å­˜ä¸­ï¼Œä¸æŒä¹…ã€‚
- åœºæ™¯ï¼šè¦æ±‚äº‹åŠ¡çš„å®Œæ•´æ€§ã€å¹¶å‘æ¡ä»¶ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€æ›´æ–°åˆ é™¤æ“ä½œå¤šï¼Œé€‚åˆinnodbï¼›è¯»å’Œæ’å…¥å¤šï¼Œmyisamï¼›ä¸´æ—¶è¡¨å’Œç¼“å­˜ï¼Œmemoryã€‚


## mysql b+æ ‘å’Œbæ ‘

B+æ ‘å’ŒBæ ‘éƒ½æ˜¯å¸¸ç”¨çš„ç´¢å¼•ç»“æž„ï¼Œç”¨äºŽåœ¨æ•°æ®åº“ä¸­è¿›è¡Œé«˜æ•ˆçš„æ•°æ®æ£€ç´¢ã€‚å®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºŽå¶å­èŠ‚ç‚¹çš„ç»“æž„å’Œä½¿ç”¨æ–¹å¼ã€‚

Bæ ‘ï¼ˆB-Treeï¼‰æ˜¯ä¸€ç§å¤šå‰è·¯è¡¡æŸ¥æ‰¾æ ‘
- æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨å¤šä¸ªå…³é”®å­—å’Œå¯¹åº”çš„æ•°æ®æŒ‡é’ˆï¼Œå³éžå¶å­èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹éƒ½ä¼šå­˜æ”¾æ•°æ®ã€‚
- éžå¶å­èŠ‚ç‚¹å­˜æ”¾æŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚
- æœç´¢æœ‰å¯èƒ½åœ¨éžå¶å­ç»“ç‚¹ç»“æŸ

B+æ ‘ï¼š
- éžå¶å­èŠ‚ç‚¹ä»…ä»…èµ·åˆ°ç´¢å¼•æ•°æ®ä½œç”¨ï¼Œåªå­˜å‚¨å…³é”®å­—å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚
- æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šå‡ºçŽ°åœ¨å¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹ä¹‹é—´é€šè¿‡æŒ‡é’ˆè¿žæŽ¥å½¢æˆä¸€ä¸ªæœ‰åºåŒå‘é“¾è¡¨ã€‚

åŒºåˆ«ï¼š
1. æŸ¥è¯¢ç¨³å®šæ€§ï¼šBæ ‘æœç´¢æœ‰å¯èƒ½åœ¨éžå¶å­ç»“ç‚¹ç»“æŸï¼Œæœ€å¥½æ˜¯O(1)ï¼Œè€ŒB+æ ‘ä¸€å®šä¼šæŸ¥åˆ°å¶å­èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢ç¨³å®šï¼Œlogn
2. B+æ ‘ç£ç›˜IOæ•ˆçŽ‡æ›´é«˜ï¼šå› ä¸ºBæ ‘å¯èƒ½æŸ¥è¯¢åˆ°éžå¶å­èŠ‚ç‚¹ï¼Œæ¯”éƒ½æ˜¯å¶å­èŠ‚ç‚¹çš„B+æ ‘ï¼Œå°±å¤šå¸¦äº†å­èŠ‚ç‚¹æŒ‡é’ˆï¼ŒåŒæ ·ä¸€é¡µè¯»å–çš„ç´¢å¼•æ ‘å°±å°‘ã€‚è€Œä¸”ï¼ŒB+æ ‘çš„æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸Šï¼Œä»¥é“¾è¡¨è¿žæŽ¥ï¼Œåœ¨ç£ç›˜ä¸­é¡ºåºæ˜¯è¿žç»­çš„ï¼Œæ›´èƒ½åˆ©ç”¨ç£ç›˜IOçš„å±€éƒ¨æ€§åŽŸç†é¢„è¯»ã€‚
3. Bæ ‘çš„å…³é”®å­—å’Œæ•°æ®åœ¨ä¸€èµ·ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œè€ŒB+æ ‘å¶å­èŠ‚ç‚¹å½¢æˆé“¾è¡¨ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚


## ä¸ºä»€ä¹ˆInnoDBå­˜å‚¨å¼•æ“Žé€‰æ‹©ä½¿ç”¨B+treeç´¢å¼•ç»“æž„?

> ç›´æŽ¥è¯´

é€‰æ‹©B+æ ‘çš„ä¸»è¦çš„åŽŸå› æ˜¯ï¼š

ç¬¬ä¸€é˜¶æ•°æ›´å¤šï¼Œè·¯å¾„æ›´çŸ­ï¼Œ

ç¬¬äºŒä¸ªç£ç›˜è¯»å†™ä»£ä»·B+æ ‘æ›´ä½Žï¼Œéžå¶å­èŠ‚ç‚¹åªå­˜å‚¨æŒ‡é’ˆï¼Œå¶å­é˜¶æ®µå­˜å‚¨æ•°æ®ï¼Œ

ç¬¬ä¸‰æ˜¯B+æ ‘ä¾¿äºŽæ‰«åº“å’ŒåŒºé—´æŸ¥è¯¢ï¼Œå¶å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨

> ä¸ºä»€ä¹ˆä¸ç”¨çº¢é»‘æ ‘

çº¢é»‘æ ‘æ˜¯äºŒå‰æ ‘ï¼Œä¸å¦‚B+æ ‘é˜¶æ•°å¤šã€å±‚çº§çŸ®ã€‚

çº¢é»‘æ ‘ä¸Šé€»è¾‘ç›¸é‚»èŠ‚ç‚¹å¯èƒ½å®žé™…å­˜å‚¨éžå¸¸è¿œï¼Œè¿™ç§ç»“æž„å†…å­˜ä¸­å¯ä»¥å¿«é€Ÿç¡®å®šä½ç½®ï¼Œä½†ä¸åˆ©äºŽç£ç›˜çš„å±€éƒ¨æ€§åŽŸç†é¢„è¯»ã€‚

> ä¸ºä»€ä¹ˆä¸ç”¨Hashç´¢å¼•

è™½ç„¶hashæŸ¥è¯¢æ•ˆçŽ‡é«˜ï¼Œä¸å­˜åœ¨hashå†²çªæ—¶åªéœ€è¦ä¸€æ¬¡æ£€ç´¢å°±å¯ä»¥äº†ï¼Œæ•ˆçŽ‡é€šå¸¸è¦é«˜äºŽB+treeç´¢å¼•

ä½†Hashç´¢å¼•åªèƒ½ç”¨äºŽå¯¹ç­‰æ¯”è¾ƒ(=ï¼Œin)ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œæ— æ³•åˆ©ç”¨ç´¢å¼•å®ŒæˆæŽ’åºæ“ä½œ



## InnoDBä¸»é”®ç´¢å¼•çš„B+treeé«˜åº¦ä¸ºå¤šé«˜å‘¢?

ä¸€é¡µ16KBã€‚

innodbçš„æŒ‡é’ˆ6å­—èŠ‚ã€ä¸»é”®å³ä½¿ä¸ºbigintä¸º8å­—èŠ‚ã€‚

ä¸€é¡µå­˜B+treeç´¢å¼•ï¼ˆnä¸ªkeyï¼Œn+1ä¸ªæŒ‡é’ˆï¼‰ï¼Œå¯ä»¥å­˜ n * 8 + (n + 1) * 6 = 16 * 1024 â†’ n = 1170

ä¸€è¡Œæ•°æ®å¤§å°ä¸º1Kï¼Œä¸€é¡µå¯ä»¥æœ‰16è¡Œæ•°æ®ã€‚é‚£ä¹ˆ1171 * 16 = 18736 è¡Œæ•°æ®ï¼Œå¾—å‡ºå½“B+æ ‘é«˜åº¦ä¸º2çš„æ—¶å€™å¯ä»¥å­˜å‚¨18736 è¡Œæ•°æ®ã€‚

é«˜åº¦**3**ï¼š1171 x 1171 x 16 = **2200W** è¡Œæ•°æ®


## äº†è§£è¿‡ç´¢å¼•å—ï¼Ÿï¼ˆä»€ä¹ˆæ˜¯ç´¢å¼•ï¼‰

ç´¢å¼•æ˜¯**å¸®åŠ©MySQLé«˜æ•ˆèŽ·å–æ•°æ®çš„æ•°æ®ç»“æž„**ï¼Œä¸»è¦æ˜¯ç”¨æ¥æé«˜æ•°æ®æ£€ç´¢çš„æ•ˆçŽ‡ï¼Œé™ä½Žæ•°æ®åº“çš„IOæˆæœ¬ï¼ŒåŒæ—¶é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡ŒæŽ’åºï¼Œé™ä½Žæ•°æ®æŽ’åºçš„æˆæœ¬ï¼Œä¹Ÿèƒ½é™ä½Žäº†CPUçš„æ¶ˆè€—

## ç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æž„äº†è§£è¿‡å˜› ? 

MySQLçš„é»˜è®¤çš„å­˜å‚¨å¼•æ“ŽInnoDBé‡‡ç”¨çš„B+æ ‘çš„æ•°æ®ç»“æž„æ¥å­˜å‚¨ç´¢å¼•

## mysqlçš„ç´¢å¼•æœ‰å“ªäº›

ç´¢å¼•ç»“æž„æœ‰å“ªäº›ï¼šB+æ ‘ç´¢å¼•ã€hashç´¢å¼•ã€ç©ºé—´ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€‚

å…·ä½“ç±»åž‹åˆ†ä¸ºï¼šä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€å¸¸è§„ç´¢å¼•ã€è”åˆç´¢å¼•

å­˜å‚¨å½¢å¼åˆ†ä¸ºï¼šèšé›†ç´¢å¼•ã€äºŒçº§ç´¢å¼•ã€‚

## èšé›†ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•

èšç°‡ç´¢å¼•ä¸»è¦æ˜¯æŒ‡**æ•°æ®ä¸Žç´¢å¼•æ”¾åˆ°ä¸€å—**ï¼ŒB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¿å­˜äº†**æ•´è¡Œæ•°æ®**

éžèšç°‡ç´¢å¼•å€¼çš„æ˜¯**æ•°æ®ä¸Žç´¢å¼•åˆ†å¼€å­˜å‚¨**ï¼ŒB+æ ‘çš„å¶å­èŠ‚ç‚¹ä¿å­˜å¯¹åº”çš„**ä¸»é”®**

- èšé›†ç´¢å¼•å¿…é¡»æœ‰,è€Œä¸”åªæœ‰ä¸€ä¸ªï¼›äºŒçº§ç´¢å¼•å¯ä»¥æœ‰å¤šä¸ªã€‚
- èšé›†ç´¢å¼•ç›´æŽ¥æŸ¥ï¼ŒäºŒçº§ç´¢å¼•è¿˜å¾—å›žè¡¨æŸ¥è¯¢ã€‚

## å›žè¡¨æŸ¥è¯¢

å…ˆåˆ°äºŒçº§ç´¢å¼•ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œæ‰¾åˆ°**ä¸»é”®å€¼**ï¼Œ

ç„¶åŽå†åˆ°èšé›†ç´¢å¼•ä¸­æ ¹æ®ä¸»é”®å€¼ï¼ŒèŽ·å–**æ•°æ®**ã€‚

## ðŸš€èšé›†ç´¢å¼•é€‰å–è§„åˆ™

1. ä¸»é”®ç´¢å¼•
2. ç¬¬ä¸€ä¸ªå”¯ä¸€ï¼ˆUNIQUEï¼‰ç´¢å¼•
3. è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªrowid

## è”åˆç´¢å¼•åº•å±‚å­˜å‚¨ç»“æž„(å’Œå…¶ä»–ç§ç±»çš„ç´¢å¼•çš„å­˜å‚¨ç»“æž„æœ‰ä»€ä¹ˆåŒºåˆ«?)

è”åˆç´¢å¼•åœ¨å¤šä¸ªåˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ä¸Žå•åˆ—ç´¢å¼•ç›¸æ¯”

1.  **å­˜å‚¨æ•°æ®çš„ç»„ç»‡æ–¹å¼**ï¼š
    
    -   å•åˆ—ç´¢å¼•åªåŒ…å«ä¸€ä¸ªåˆ—çš„å€¼å’ŒæŒ‡å‘ç›¸åº”æ•°æ®è¡Œçš„æŒ‡é’ˆã€‚
    -   è”åˆç´¢å¼•åˆ™åŒ…å«**å¤šä¸ªåˆ—**çš„å€¼ï¼Œä»¥åŠæŒ‡å‘ç›¸åº”æ•°æ®è¡Œçš„æŒ‡é’ˆã€‚
2.  **æŸ¥è¯¢æ—¶çš„æ€§èƒ½å½±å“**ï¼š
    
    -   å½“æŸ¥è¯¢æ¡ä»¶æ¶‰åŠåˆ°å•ä¸ªç´¢å¼•åˆ—æ—¶ï¼Œæ•°æ®åº“å¯ä»¥é€šè¿‡å•åˆ—ç´¢å¼•æ¥æ›´å¿«åœ°å®šä½åˆ°åŒ¹é…çš„æ•°æ®è¡Œã€‚
    -   è”åˆç´¢å¼•åœ¨é€‚å½“çš„æƒ…å†µä¸‹å¯ä»¥æä¾›æ›´å¥½çš„æŸ¥è¯¢æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯å¯¹äºŽæ¶‰åŠåˆ°è”åˆç´¢å¼•ä¸­**åˆ—å€¼çš„ç»„åˆ**çš„æŸ¥è¯¢ã€‚
3.  **ç´¢å¼•ç»´æŠ¤çš„å¤æ‚æ€§**ï¼š
    
    -   å•åˆ—ç´¢å¼•çš„ç»´æŠ¤ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒåªéœ€è¦ç»´æŠ¤å•ä¸ªåˆ—çš„å€¼å’ŒæŒ‡é’ˆã€‚
    -   è”åˆç´¢å¼•çš„åˆ›å»ºå’Œç»´æŠ¤ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå½“è¡¨ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ•°æ®åº“éœ€è¦ç¡®ä¿è”åˆç´¢å¼•ä¸­çš„å¤šä¸ªåˆ—å€¼çš„ç»„åˆä¿æŒæœ‰åºï¼Œè¿™å¯èƒ½éœ€è¦æ›´å¤šçš„èµ„æºå’Œæ—¶é—´ã€‚

## è”åˆç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜çš„ä»€ä¹ˆå†…å®¹?

ç´¢å¼•åˆ—çš„å€¼å’Œ**ä¸»é”®id**ã€‚

- å¦‚æžœè¦æŸ¥è¯¢è¯­å¥ä¸­æŸ¥è¯¢çš„æ˜¯**è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®**ï¼Œåˆ™å›žè¡¨ã€‚å…ˆé€šè¿‡è”åˆç´¢å¼•æ ‘æ‰¾åˆ°ä¸»é”®IDï¼Œç„¶åŽå†æ ¹æ®ä¸»é”®ç´¢å¼•æ ‘æ‰¾åˆ°å¯¹åº”dataæ•°æ®ã€‚
- å½“æˆ‘ä»¬æŸ¥è¯¢çš„å­—æ®µæ˜¯**è”åˆç´¢å¼•ä¸­çš„å­—æ®µ**ï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œå›žè¡¨ã€‚
## è¦†ç›–ç´¢å¼•

è¦†ç›–ç´¢å¼•æ˜¯æŒ‡**selectæŸ¥è¯¢è¯­å¥ä½¿ç”¨äº†ç´¢å¼•ï¼ŒæŸ¥è¯¢è¿”å›žçš„åˆ—å¿…é¡»åœ¨ç´¢å¼•ä¸­èƒ½å¤Ÿå…¨éƒ¨æ‰¾åˆ°**ã€‚å³ä¸éœ€è¦å›žè¡¨æŸ¥è¯¢ã€‚

- idæŸ¥è¯¢ï¼Œå®ƒä¼šç›´æŽ¥èµ°èšé›†ç´¢å¼•æŸ¥è¯¢ï¼Œä¸€æ¬¡ç´¢å¼•æ‰«æï¼Œç›´æŽ¥è¿”å›žæ•°æ®ï¼Œæ€§èƒ½é«˜ã€‚
- å¦‚æžœæŒ‰ç…§äºŒçº§ç´¢å¼•æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œè¿”å›žçš„åˆ—ä¸­æ²¡æœ‰åˆ›å»ºç´¢å¼•ï¼Œæœ‰å¯èƒ½ä¼šè§¦å‘å›žè¡¨æŸ¥è¯¢ï¼Œå°½é‡é¿å…ä½¿ç”¨select *ï¼Œå°½é‡åœ¨è¿”å›žçš„åˆ—ä¸­éƒ½åŒ…å«æ·»åŠ ç´¢å¼•çš„å­—æ®µ

![alt text](../../images/image-212.png)


## MYSQLè¶…å¤§åˆ†é¡µæ€Žä¹ˆå¤„ç† ?

åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œä½¿ç”¨limitåˆ†é¡µæŸ¥è¯¢ï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡ŒæŽ’åºï¼Œæ•ˆçŽ‡ä½Žã€‚

ä¼˜åŒ–ï¼šè¦†ç›–ç´¢å¼•+å­æŸ¥è¯¢

å…ˆåˆ†é¡µæŸ¥è¯¢æ•°æ®çš„idå­—æ®µï¼Œç¡®å®šäº†idä¹‹åŽï¼Œå†ç”¨å­æŸ¥è¯¢æ¥è¿‡æ»¤ï¼ŒåªæŸ¥è¯¢è¿™ä¸ªidåˆ—è¡¨ä¸­çš„æ•°æ®å°±å¯ä»¥äº†

![alt text](../../images/image-213.png)

## ç´¢å¼•å¤±æ•ˆ

1. è”åˆç´¢å¼•å¤±æ•ˆã€‚
   - è·³è·ƒæŸä¸€åˆ—ï¼Œç´¢å¼•å°†ä¼šéƒ¨åˆ†å¤±æ•ˆã€‚
   - å‡ºçŽ°èŒƒå›´æŸ¥è¯¢(>,<)ï¼ŒèŒƒå›´æŸ¥è¯¢å³ä¾§çš„åˆ—ç´¢å¼•å¤±æ•ˆã€‚å½“èŒƒå›´æŸ¥è¯¢ä½¿ç”¨>= æˆ– <= æ—¶ï¼Œèµ°è”åˆç´¢å¼•äº†ã€‚

2. åœ¨ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè¿ç®—æ“ä½œ

3. å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ã€‚å¯¹äºŽæŸ¥è¯¢ç»“æžœï¼Œæ²¡ä»€ä¹ˆå½±å“ï¼Œä½†æ˜¯æ•°æ®åº“å­˜åœ¨éšå¼ç±»åž‹è½¬æ¢ï¼Œç´¢å¼•å°†å¤±æ•ˆã€‚

4. å¦‚æžœæ˜¯**å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…**ï¼Œç´¢å¼•å¤±æ•ˆã€‚å¦‚æžœä»…ä»…æ˜¯å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆã€‚

5. orè¿žæŽ¥æ¡ä»¶ã€‚è¿žæŽ¥æ¡ä»¶ä¸­éƒ½æœ‰ç´¢å¼•æ‰ä¸å¤±æ•ˆï¼Œå¦åˆ™éƒ½å¤±æ•ˆã€‚

6. MySQLè¯„ä¼°ã€‚MySQLåœ¨æŸ¥è¯¢æ—¶ï¼Œä¼šè¯„ä¼°ä½¿ç”¨ç´¢å¼•çš„æ•ˆçŽ‡ä¸Žèµ°å…¨è¡¨æ‰«æçš„æ•ˆçŽ‡ï¼Œå¦‚æžœèµ°å…¨è¡¨æ‰«ææ›´å¿«ï¼Œåˆ™æ”¾å¼ƒç´¢å¼•ï¼Œèµ°å…¨è¡¨æ‰«æã€‚

## ç´¢å¼•è®¾è®¡åŽŸåˆ™
- æ•°æ®é‡è¾ƒå¤§ï¼ˆå•è¡¨å¤§äºŽ10ä¸‡ï¼‰ï¼Œä¸”æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„è¡¨å»ºç«‹ç´¢å¼•ã€‚
- è¦æŽ§åˆ¶ç´¢å¼•çš„æ•°é‡ï¼Œç´¢å¼•å¹¶ä¸æ˜¯å¤šå¤šç›Šå–„ï¼Œç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•ç»“æž„çš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼Œä¼šå½±å“å¢ž
- é’ˆå¯¹äºŽå¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼ˆwhereï¼‰ã€æŽ’åºï¼ˆorder byï¼‰ã€åˆ†ç»„ï¼ˆgroup byï¼‰æ“ä½œçš„å­—æ®µå»ºç«‹ç´¢
å¼•ã€‚
- å°½é‡é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—ä½œä¸ºç´¢å¼•ï¼Œå°½é‡å»ºç«‹å”¯ä¸€ç´¢å¼•ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œä½¿ç”¨ç´¢å¼•çš„æ•ˆçŽ‡è¶Šé«˜ã€‚
- å°½é‡ä½¿ç”¨è”åˆç´¢å¼•ï¼Œå‡å°‘å•åˆ—ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶ï¼Œè”åˆç´¢å¼•å¾ˆå¤šæ—¶å€™å¯ä»¥è¦†ç›–ç´¢å¼•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œ
- å¦‚æžœæ˜¯å­—ç¬¦ä¸²ç±»åž‹çš„å­—æ®µï¼Œå­—æ®µçš„é•¿åº¦è¾ƒé•¿ï¼Œå¯ä»¥é’ˆå¯¹äºŽå­—æ®µçš„ç‰¹ç‚¹ï¼Œå»ºç«‹å‰ç¼€ç´¢å¼•ã€‚
- é¿å…å›žè¡¨ï¼Œæé«˜æŸ¥è¯¢æ•ˆçŽ‡ã€‚
- å¦‚æžœç´¢å¼•åˆ—ä¸èƒ½å­˜å‚¨NULLå€¼ï¼Œè¯·åœ¨åˆ›å»ºè¡¨æ—¶ä½¿ç”¨NOT NULLçº¦æŸå®ƒã€‚å½“ä¼˜åŒ–å™¨çŸ¥é“æ¯åˆ—æ˜¯å¦åŒ…å«NULLå€¼æ—¶ï¼Œå®ƒå¯ä»¥æ›´å¥½åœ°ç¡®å®šå“ªä¸ªç´¢å¼•æœ€æœ‰æ•ˆåœ°ç”¨äºŽæŸ¥è¯¢ã€‚

## MySQLä¸­çš„é”

æŒ‰ç…§é”çš„ç²’åº¦åˆ†ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š
- å…¨å±€é”ï¼šé”å®šæ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ã€‚
- è¡¨çº§é”ï¼ˆ3-2X2ï¼‰ï¼šæ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ã€‚
- è¡Œçº§é”ï¼ˆ3-211ï¼‰ï¼šæ¯æ¬¡æ“ä½œé”ä½å¯¹åº”çš„è¡Œæ•°æ®ã€‚

è¡¨çº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š
- è¡¨é”
- å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDLï¼‰
- æ„å‘é”

è¡¨é”ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š
- è¡¨å…±äº«è¯»é”ï¼ˆread lockï¼‰
- è¡¨ç‹¬å å†™é”ï¼ˆwrite lockï¼‰

å…ƒæ•°æ®é”ï¼šDMLå’ŒDDL
- å…ƒæ•°æ®å…±äº«è¯»é” SHARED_READ
- å…ƒæ•°æ®å…±äº«å†™é” SHARED_WRITE
- å…ƒæ•°æ®æŽ’ä»–é” EXCLUSIVE
- ...


æ„å‘é”ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š(è‡ªåŠ¨)
- æ„å‘å…±äº«é”(IS)
- æ„å‘æŽ’ä»–é”(IX)

å¯¹äºŽè¡Œçº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š
- è¡Œé”ï¼ˆRecord Lockï¼‰
- é—´éš™é”ï¼ˆGap Lockï¼‰
- ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰


è¡Œé”ï¼š
- å…±äº«é”ï¼ˆSï¼‰
- æŽ’ä»–é”ï¼ˆXï¼‰

|è¯­å¥|è¡¨é”|è¡Œé”|
|-|-|-|
|`select`|SHARED_READå…ƒæ•°æ®è¯»é”||
|`SELECT ... LOCK IN SHARE MODE`|SHARED_READå…ƒæ•°æ®è¯»é”ã€æ„å‘å…±äº«é”IS|è¡Œå…±äº«é”|
|`SELECT ... FOR UPDATE`| SHARED_WRITEå…ƒæ•°æ®å†™é”ã€æ„å‘æŽ’ä»–é”IX|è¡ŒæŽ’ä»–é”|
|`insert` ã€`update`ã€`delete`|SHARED_WRITEå…ƒæ•°æ®å†™é”ã€æ„å‘æŽ’ä»–é”IX|è¡ŒæŽ’ä»–é”|
|`alter table ...`|EXCLUSIVEå…ƒæ•°æ®æŽ’ä»–é”||

## æ•°æ®åº“ä¸»ä»ŽåŒæ­¥

1. MySQL master å°†æ•°æ®å˜æ›´å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—binlog
2. MySQL slave è¯»å– master çš„ binlogï¼Œå†™å…¥åˆ°è‡ªå·±çš„ä¸­ç»§æ—¥å¿—relay logä¸­ã€‚
3. MySQL slave é‡æ”¾ relay log ä¸­äº‹ä»¶ï¼Œå°†æ•°æ®å˜æ›´ã€‚

## MySQLä¸­ï¼Œå¦‚ä½•å®šä½æ…¢æŸ¥è¯¢?

1. åŽ‹æµ‹+skywalkingè¿ç»´ç›‘æŽ§
2. sqlæ…¢æ—¥å¿—ï¼šå¼€å¯æ…¢æ—¥å¿—ã€é…ç½®è¶…è¿‡å¤šé•¿æ‰§è¡Œçš„sqlå°±æ˜¯æ…¢sqlã€‚

## é‚£è¿™ä¸ªSQLè¯­å¥æ‰§è¡Œå¾ˆæ…¢, å¦‚ä½•åˆ†æžå‘¢ï¼Ÿ

explainæŸ¥çœ‹sqlæ‰§è¡Œæƒ…å†µï¼š
- keyå’Œkey_lenå­—æ®µï¼šæ£€æŸ¥æ˜¯å¦å‘½ä¸­äº†ç´¢å¼•
- typeå­—æ®µï¼šæ˜¯å¦å­˜åœ¨å…¨ç´¢å¼•æ‰«ææˆ–å…¨ç›˜æ‰«æ
- extraå­—æ®µï¼šæ˜¯å¦å‡ºçŽ°äº†å›žè¡¨æŸ¥è¯¢

## bin logã€undo logã€redo logçš„åŒºåˆ«
- bin logï¼š è®°å½•çš„DDLå’ŒDMLè¯­å¥ï¼Œä¸åŒ…æ‹¬æŸ¥è¯¢ï¼ˆselectã€showï¼‰è¯­å¥ã€‚ä¸»ä»ŽåŒæ­¥ç”¨çš„ã€‚
- undo log ï¼šè®°å½•çš„æ˜¯**é€»è¾‘æ—¥å¿—**ï¼Œå½“**äº‹åŠ¡å›žæ»š**æ—¶ï¼Œé€šè¿‡é€†æ“ä½œæ¢å¤åŽŸæ¥çš„æ•°æ®
- redo log: è®°å½•çš„æ˜¯**æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–**ï¼ŒæœåŠ¡**å®•æœº**å¯ç”¨æ¥åŒæ­¥æ•°æ®
- undo logä¿è¯äº†äº‹åŠ¡çš„åŽŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œredo logä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€‚


## äº‹åŠ¡ä¸­çš„éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Ÿ(ä½ è§£é‡Šä¸€ä¸‹MVCC)

äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯ç”±é”å’Œmvccå®žçŽ°çš„ã€‚

mvccçš„æ„æ€æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ã€‚æŒ‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªï¼Œå®ƒçš„åº•å±‚å®žçŽ°ä¸»è¦æ˜¯åˆ†ä¸ºäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªæ˜¯**éšè—å­—æ®µ**ï¼Œç¬¬äºŒä¸ªæ˜¯**undo logæ—¥å¿—**ï¼Œç¬¬ä¸‰ä¸ªæ˜¯**readViewè¯»è§†å›¾**

éšè—å­—æ®µæ˜¯æŒ‡ï¼šåœ¨mysqlä¸­ç»™æ¯ä¸ªè¡¨éƒ½è®¾ç½®äº†éšè—å­—æ®µï¼Œæœ‰ä¸€ä¸ªæ˜¯trx_id(**äº‹åŠ¡id**)ï¼Œè®°å½•æ¯ä¸€æ¬¡æ“ä½œçš„äº‹åŠ¡idï¼Œæ˜¯è‡ªå¢žçš„ï¼›å¦ä¸€ä¸ªå­—æ®µæ˜¯roll_pointer(**å›žæ»šæŒ‡é’ˆ**)ï¼ŒæŒ‡å‘ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„äº‹åŠ¡ç‰ˆæœ¬è®°å½•åœ°å€

undo logä¸»è¦çš„ä½œç”¨æ˜¯è®°å½•å›žæ»šæ—¥å¿—ï¼Œå­˜å‚¨è€ç‰ˆæœ¬æ•°æ®ï¼Œåœ¨å†…éƒ¨ä¼šå½¢æˆä¸€ä¸ª**ç‰ˆæœ¬é“¾**ï¼Œåœ¨å¤šä¸ªäº‹åŠ¡å¹¶è¡Œæ“ä½œæŸä¸€è¡Œè®°å½•ï¼Œè®°å½•ä¸åŒäº‹åŠ¡ä¿®æ”¹æ•°æ®çš„ç‰ˆæœ¬ï¼Œé€šè¿‡roll_pointeræŒ‡é’ˆå½¢æˆä¸€ä¸ªé“¾è¡¨

readViewè§£å†³çš„æ˜¯ä¸€ä¸ª**äº‹åŠ¡æŸ¥è¯¢é€‰æ‹©ç‰ˆæœ¬**çš„é—®é¢˜ï¼Œåœ¨å†…éƒ¨å®šä¹‰äº†ä¸€äº›åŒ¹é…è§„åˆ™å’Œå½“å‰çš„ä¸€äº›äº‹åŠ¡idåˆ¤æ–­è¯¥è®¿é—®é‚£ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸åŒçš„éš”ç¦»çº§åˆ«å¿«ç…§è¯»æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€ç»ˆçš„è®¿é—®çš„ç»“æžœä¸ä¸€æ ·ã€‚å¦‚æžœæ˜¯rcéš”ç¦»çº§åˆ«ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œå¦‚æžœæ˜¯rréš”ç¦»çº§åˆ«ä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼ŒåŽç»­å¤ç”¨

## MySQLä¸»ä»ŽåŒæ­¥åŽŸç† 

MySQLä¸»ä»Žå¤åˆ¶çš„æ ¸å¿ƒå°±æ˜¯äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå®ƒçš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼š

ç¬¬ä¸€ï¼šä¸»åº“åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šæŠŠæ•°æ®å˜æ›´è®°å½•åœ¨äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ Binlog ä¸­ã€‚

ç¬¬äºŒï¼šä»Žåº“çš„IO threadè¯»å–ä¸»åº“çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ Binlog ï¼Œå†™å…¥åˆ°ä»Žåº“çš„ä¸­ç»§æ—¥å¿— Relay Log ã€‚

ç¬¬ä¸‰ï¼šä»Žåº“çš„SQL threadé‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åæ˜ å®ƒè‡ªå·±çš„æ•°æ®

## åˆ†åº“åˆ†è¡¨

åˆ†åº“åˆ†è¡¨çš„æ—¶æœºï¼šå•è¡¨æ•°æ®é‡1000wæˆ–20G

æ‹†åˆ†ç­–ç•¥ï¼šï¼ˆæ°´å¹³ï¼šsharing-sphereã€mycatï¼‰
- æ°´å¹³åˆ†åº“ï¼šè§£å†³æµ·é‡æ•°æ®å­˜å‚¨å’Œé«˜å¹¶å‘é—®é¢˜ã€‚
- æ°´å¹³åˆ†è¡¨ï¼šè§£å†³å•è¡¨å­˜å‚¨å’Œæ€§èƒ½é—®é¢˜
- åž‚ç›´åˆ†åº“ï¼šæ ¹æ®ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œè§£å†³é«˜å¹¶å‘ä¸‹ç£æ³¡IOå’Œç½‘ç»œè¿žæŽ¥æ•°
- åž‚ç›´åˆ†è¡¨ï¼šå†·çƒ­æ•°æ®åˆ†ç¦»ï¼Œå‡å°‘IOäº‰æŠ¢ã€‚

å› ä¸ºæˆ‘ä»¬éƒ½æ˜¯å¾®æœåŠ¡å¼€å‘ï¼Œæ¯ä¸ªå¾®æœåŠ¡å¯¹åº”äº†ä¸€ä¸ªæ•°æ®åº“ï¼Œæ˜¯æ ¹æ®ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†çš„ï¼Œè¿™ä¸ªå…¶å®žå°±æ˜¯åž‚ç›´æ‹†åˆ†ã€‚

PSï¼šæ°´å¹³æ˜¯æ²¡æœ‰ä¸Šä¸‹çº§å…³ç³»ï¼Œè¡¨çš„ç»“æž„éƒ½ä¸€æ ·ï¼›åž‚ç›´ï¼Œç«–ç€åˆ‡ï¼Œå³åˆ†åˆ—ã€‚

## é‚£ä½ ä¹‹å‰ä½¿ç”¨è¿‡æ°´å¹³åˆ†åº“å—ï¼Ÿ

æˆ‘ä»¬å½“æ—¶çš„ä¸šåŠ¡æ˜¯(xxx)ï¼Œä¸€å¼€å§‹ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å•åº“ï¼ŒåŽæ¥è¿™ä¸ªä¸šåŠ¡é€æ¸å‘å±•ï¼Œä¸šåŠ¡é‡ä¸Šæ¥çš„å¾ˆè¿…é€Ÿï¼Œå…¶ä¸­(xx)è¡¨å·²ç»å­˜æ”¾äº†è¶…è¿‡1000ä¸‡çš„æ•°æ®ï¼Œæˆ‘ä»¬åšäº†å¾ˆå¤šä¼˜åŒ–ä¹Ÿä¸å¥½ä½¿ï¼Œæ€§èƒ½ä¾ç„¶å¾ˆæ…¢ï¼Œæ‰€ä»¥å½“æ—¶å°±ä½¿ç”¨äº†æ°´å¹³åˆ†åº“ã€‚

æˆ‘ä»¬ä¸€å¼€å§‹å…ˆåšäº†3å°æœåŠ¡å™¨å¯¹åº”äº†3ä¸ªæ•°æ®åº“ï¼Œç”±äºŽåº“å¤šäº†ï¼Œéœ€è¦åˆ†ç‰‡ï¼Œæˆ‘ä»¬å½“æ—¶é‡‡ç”¨çš„mycatæ¥ä½œä¸ºæ•°æ®åº“çš„ä¸­é—´ä»¶ã€‚æ•°æ®éƒ½æ˜¯æŒ‰ç…§idï¼ˆè‡ªå¢žï¼‰å–æ¨¡çš„æ–¹å¼æ¥å­˜å–çš„ã€‚

å½“ç„¶ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œé‚£äº›æ—§æ•°æ®ï¼Œæˆ‘ä»¬åšäº†ä¸€äº›æ¸…æ´—çš„å·¥ä½œï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯æŒ‰ç…§idå–æ¨¡è§„åˆ™åˆ†åˆ«å­˜å‚¨åˆ°äº†å„ä¸ªæ•°æ®åº“ä¸­ï¼Œå¥½å¤„å°±æ˜¯å¯ä»¥è®©å„ä¸ªæ•°æ®åº“åˆ†æ‘Šå­˜å‚¨å’Œè¯»å–çš„åŽ‹åŠ›ï¼Œè§£å†³äº†æˆ‘ä»¬å½“æ—¶æ€§èƒ½çš„é—®é¢˜
